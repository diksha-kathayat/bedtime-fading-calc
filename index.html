<script>
    function minutesToTime(m) {
        let totalMins = Math.round(m);
        // Corrects the negative minutes/wraparound bug
        while (totalMins < 0) totalMins += 1440;

        let h = Math.floor(totalMins / 60) % 24;
        let mins = totalMins % 60;
        return String(h).padStart(2, '0') + ":" + String(mins).padStart(2, '0');
    }

    function calculatePrescription() {
        const history = getHistory();
        const count = history.length;

        // Baseline Inputs
        const bWake = document.getElementById('base-wake').value; // 09:27
        const bBed = document.getElementById('base-bed').value;   // 09:08
        const bSol = parseInt(document.getElementById('base-sol').value); // 18
        const bWaso = parseInt(document.getElementById('base-waso').value); // 5

        const wakeMins = roundToNearest5(timeToMinutes(bWake));
        document.getElementById('res-wake').innerText = minutesToTime(wakeMins);

        const bBedMins = timeToMinutes(bBed);
        let wakeTotal = wakeMins; if (wakeTotal <= bBedMins) wakeTotal += 1440;
        const bActualSleep = (wakeTotal - bBedMins) - bSol - bWaso;

        // The "Phase 1" Anchor (Static Result: 09:55)
        let phase1Bed = (bSol > 15 && bWaso <= 15) ? (bBedMins + bSol) + 30 : wakeTotal - (bActualSleep - 30);

        let targetBed;
        if (count < 2) {
            // FORCE 09:55 for the first two nights regardless of log
            targetBed = phase1Bed;
            document.getElementById('logic-info').innerText = `Static Phase (Night ${count + 1}): Prescription is fixed at ${minutesToTime(phase1Bed)}.`;
        } else {
            // START ADJUSTMENTS on Night 3
            const lastLog = history[count - 1];
            const last2 = history.slice(-2);
            const avgSol = (last2[0].sol + last2[1].sol) / 2;
            const avgWaso = (last2[0].waso + last2[1].waso) / 2;
            const prevBedMins = timeToMinutes(lastLog.bedtime);

            if (avgSol <= 15 && avgWaso <= 15) {
                targetBed = prevBedMins - 15;
            } else {
                targetBed = prevBedMins + 15;
            }
        }

        targetBed = roundToNearest5(targetBed);
        document.getElementById('res-bed').innerText = minutesToTime(targetBed);
    }
</script>